name: Supabase Keep Alive

on:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤© UTC 03:00 (åŒ—äº¬æ—¶é—´ 11:00)
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  keepalive:
    runs-on: ubuntu-latest
    steps:
      - name: Database Keep Alive Query
        run: |
          echo "ğŸ”„ Executing database keepalive query..."
          
          # ä½¿ç”¨ç°æœ‰çš„ anon key è¿›è¡ŒçœŸæ­£çš„æ•°æ®åº“æŸ¥è¯¢
          # ä½¿ç”¨ HTTP å¤´é˜²æ­¢ç¼“å­˜ï¼Œé¿å… URL å‚æ•°è¢«è¯¯è§£æ
          timestamp=$(date +%s)
          response=$(curl -s -w "%{http_code}" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Cache-Control: no-cache, no-store, must-revalidate" \
            -H "Pragma: no-cache" \
            -H "Expires: 0" \
            -H "X-Timestamp: $timestamp" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/team_members?select=id,name&limit=1")
          
          # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
          http_code="${response: -3}"
          response_body="${response%???}"
          
          echo "ğŸ“Š HTTP Status Code: $http_code"
          echo "ğŸ“„ Response Body: $response_body"
          
          # æ£€æŸ¥çŠ¶æ€ç 
          case "$http_code" in
            200)
              echo "âœ… Database keepalive successful - query executed"
              # éªŒè¯å“åº”ä¸ä¸ºç©ºä¸”æ˜¯æœ‰æ•ˆJSON
              if [ -n "$response_body" ] && [ "$response_body" != "[]" ] && echo "$response_body" | grep -q "id"; then
                echo "âœ… Database returned valid data - connection is active"
              else
                echo "âš ï¸  Database returned empty/invalid result: $response_body"
                # å°è¯•å¤‡ç”¨æŸ¥è¯¢ - æŸ¥è¯¢ orders è¡¨
                echo "ğŸ”„ Trying backup query on orders table..."
                backup_response=$(curl -s -w "%{http_code}" \
                  -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
                  -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
                  -H "Content-Type: application/json" \
                  -H "Cache-Control: no-cache, no-store, must-revalidate" \
                  "${{ secrets.SUPABASE_URL }}/rest/v1/orders?select=id&limit=1")
                backup_code="${backup_response: -3}"
                backup_body="${backup_response%???}"
                echo "ğŸ“Š Backup query status: $backup_code, body: $backup_body"
              fi
              ;;
            400)
              echo "âŒ Bad request - check URL and parameters"
              echo "Response: $response_body"
              exit 1
              ;;
            401)
              echo "âŒ Authentication failed - check SUPABASE_ANON_KEY"
              exit 1
              ;;
            403)
              echo "âŒ Authorization failed - insufficient permissions"
              exit 1
              ;;
            404)
              echo "âŒ Table not found - check database schema"
              exit 1
              ;;
            5*)
              echo "âŒ Server error ($http_code) - Supabase may be down"
              exit 1
              ;;
            *)
              echo "âŒ Unexpected response code: $http_code"
              exit 1
              ;;
          esac
          
          echo "ğŸ‰ Keepalive completed successfully at $(date)"