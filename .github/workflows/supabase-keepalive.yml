name: Supabase Keep Alive

on:
  schedule:
    - cron: '0 3 * * *'   # æ¯å¤© UTC 03:00 (åŒ—äº¬æ—¶é—´ 11:00)
    - cron: '0 15 * * *'  # æ¯å¤© UTC 15:00 (åŒ—äº¬æ—¶é—´ 23:00)
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  keepalive:
    runs-on: ubuntu-latest
    steps:
      - name: Database Keep Alive Query
        run: |
          echo "ğŸ”„ Executing comprehensive database keepalive..."
          
          # ä½¿ç”¨ç°æœ‰çš„ anon key è¿›è¡Œå¤šæ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼Œæ¨¡æ‹ŸçœŸå®ä½¿ç”¨
          timestamp=$(date +%s)
          
          # æŸ¥è¯¢ 1: team_members è¡¨
          echo "ğŸ“‹ Querying team_members table..."
          response1=$(curl -s -w "%{http_code}" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Cache-Control: no-cache, no-store, must-revalidate" \
            -H "Pragma: no-cache" \
            -H "Expires: 0" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/team_members?select=id,name,roles&limit=5")
          
          http_code1="${response1: -3}"
          response_body1="${response1%???}"
          echo "ğŸ“Š team_members - Status: $http_code1, Data: $response_body1"
          
          # æŸ¥è¯¢ 2: orders è¡¨
          echo "ğŸ“‹ Querying orders table..."
          response2=$(curl -s -w "%{http_code}" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Cache-Control: no-cache, no-store, must-revalidate" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/orders?select=id,goal,status&limit=3")
          
          http_code2="${response2: -3}"
          response_body2="${response2%???}"
          echo "ğŸ“Š orders - Status: $http_code2, Data: $response_body2"
          
          # æŸ¥è¯¢ 3: tasks è¡¨
          echo "ğŸ“‹ Querying tasks table..."
          response3=$(curl -s -w "%{http_code}" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Cache-Control: no-cache, no-store, must-revalidate" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/tasks?select=id,title_zh,status&limit=3")
          
          http_code3="${response3: -3}"
          response_body3="${response3%???}"
          echo "ğŸ“Š tasks - Status: $http_code3, Data: $response_body3"
          
          # ç»Ÿè®¡æŸ¥è¯¢
          echo "ğŸ“‹ Getting table statistics..."
          response4=$(curl -s -w "%{http_code}" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Cache-Control: no-cache, no-store, must-revalidate" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/team_members?select=count")
          
          http_code4="${response4: -3}"
          response_body4="${response4%???}"
          echo "ğŸ“Š count query - Status: $http_code4, Data: $response_body4"
          
          # æ£€æŸ¥æ‰€æœ‰æŸ¥è¯¢ç»“æœ
          success_count=0
          total_queries=4
          
          # é€ä¸ªæ£€æŸ¥çŠ¶æ€ç å¹¶è®¡æ•°
          if [ "$http_code1" = "200" ]; then
            success_count=$((success_count + 1))
          else
            echo "âŒ team_members query failed with code: $http_code1"
          fi
          
          if [ "$http_code2" = "200" ]; then
            success_count=$((success_count + 1))
          else
            echo "âŒ orders query failed with code: $http_code2"
          fi
          
          if [ "$http_code3" = "200" ]; then
            success_count=$((success_count + 1))
          else
            echo "âŒ tasks query failed with code: $http_code3"
          fi
          
          if [ "$http_code4" = "200" ]; then
            success_count=$((success_count + 1))
          else
            echo "âŒ count query failed with code: $http_code4"
          fi
          
          echo "ğŸ“ˆ Query Summary: $success_count/$total_queries successful"
          
          if [ "$success_count" -ge 2 ]; then
            echo "âœ… Database keepalive successful - multiple queries executed"
            echo "ğŸ¯ Generated sufficient database activity to maintain project status"
            echo "ğŸ‰ Comprehensive keepalive completed at $(date)"
            exit 0
          else
            echo "âŒ Insufficient successful queries ($success_count/$total_queries)"
            echo "ğŸ‰ Keepalive attempted at $(date)"
            exit 1
          fi